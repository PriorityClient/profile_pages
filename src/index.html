<html>
	<head>
		<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
		<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
		<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<style>
			body { background: #eee; }
			.error  { color:#f00; }
			.hidden { display:none; }
			.mdl-card.main-content { width:100%; }
			.pitchArea {
					border: 1px solid rgba(0,0,0,.12);;
					width:100%;
					-webkit-box-sizing: border-box;
						 -moz-box-sizing: border-box;
									box-sizing: border-box;
			}
		</style>
		<script>
			function $(id, element, log){
				var ident = id.slice(1);
				if(id.match(/^\#[^\.]*$/)) return document.getElementById(ident);
				if(id.match(/^\./)) return document.getElementsByClassName(ident);
				return document.querySelectorAll(ident);
			}

			function addListener(el, action, fn){
				if (el.addEventListener) {
					el.addEventListener(action, fn, true);
				}
				else {
					el.attachEvent("on"+action, fn);
				}
			}

			function setupSubmitBid(formId, api){
				var element = $(formId);
				addListener(element, "submit", function(evt) {
					evt.preventDefault();
					submitBid(element, api);
				})
			}

			function check_required(firstName, lastName, description, bidAmount, emailAddress){
				var first = $(firstName).value.trim() != ''
				var last  = $(lastName).value.trim() != ''
				var desc  = $(description).value.trim() != ''
				var bid   = $(bidAmount).value.trim() != ''
				var email = $(emailAddress).value.trim() != ''
				if(!first)  $(firstName).parentElement.classList.add('is-invalid')
				if(!last)   $(lastName).parentElement.classList.add('is-invalid')
				if(!desc)   $(description).parentElement.classList.add('is-invalid')
				if(!bid)    $(bidAmount).parentElement.classList.add('is-invalid')
				if(!email)  $(emailAddress).parentElement.classList.add('is-invalid')

				return first&&last&&desc&&bid&&email
			}

			function submitBid(formElement, api){
				if(!check_required( "#pitcher-first-name", "#pitcher-last-name", "#description", "#bid-amount", "#pitcher-email")) return false;

				var user_id = $("#user-id").innerHTML;
				var user = $("#user-info").innerHTML;
				var bid = {
					"id": user_id,
					"pitcher_first_name": $("#pitcher-first-name").value,
					"pitcher_last_name": $("#pitcher-last-name").value,
					"pitcher_company_name": $("#pitcher-company-name").value,
					"pitcher_email": $("#pitcher-email").value,
					"description": $("#description").value,
					"bid_amount": parseFloat($("#bid-amount").value)
				}
				// get second page
				window.location.href = "complete.html?bid="+btoa(JSON.stringify(bid))+"&user="+btoa(user);
			}

			function setup(api){
				getUserFrom(api);
				setupSubmitBid("#bid-form", api);
				setupDescriptionCharCountDisplay("#description", "#descriptionCharacterCount", "#descriptionCharacterCountContainer", 700);
			}

		function setupDescriptionCharCountDisplay(textAreaId, counter, container, max){
				addListener($(textAreaId), "keyup", function(evt) {
					var charCount = $(textAreaId).value.length;
					$(counter).innerHTML = charCount;
					if(charCount > max) $(container).classList.add("error");
					if(charCount <= max) $(container).classList.remove("error");
				})
			}

			function getUserFrom(api){
				console.log("ready to retrieve");
				url = window.location.href.split("/profile/");
				screen_name = url[url.length-1];
				axios
					.get(api+"/users/"+screen_name)
					.then(showUser)
			}


			function showUser(result){
				var user = result.data;
				$("#user-id").innerHTML=user.id
				$("#user-info").innerHTML=JSON.stringify(result);
				$("#user-name").innerHTML=user.first_name+" "+user.last_name;
				$("#user-avatar").src=(user.avatar_url || "default.png");
				$("#email-domain").innerHTML=user.privatized_email;
				$("#user-bio").innerHTML=user.bio;
				$("#company-name").innerHTML=(user.companyName||"");
				//$("user-title").innerHTML=user.title
				var update_name = $(".substitute-variable")
				for(var i=0; i<update_name.length; i++){
					var body = update_name[i].innerHTML
					update_name[i].innerHTML = body.replace("{{user-first-name}}", user.first_name);
				}
			}
		</script>
	</head>
	<!--<body onLoad="setup('https://staging.priorityclient.com/pitches/v1')">-->
	<body onLoad="setup('http://localhost:3000/pitches/v1')">
		<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
			<header class="mdl-layout__header">
				<div class="mdl-layout__header-row">
					<!-- Title -->
					<span class="mdl-layout-title">LOGO GOES HERE</span>
				</div>
			</header>

			<main class="mdl-layout__content">

				<div class="mdl-grid">

					<div class="mdl-cell mdl-cell--3-col">

						<div class="mdl-card">
							<div>
								<img id="user-avatar" alt="username profile image">
							</div>
							<div class="mdl-card__supporting-text">
								<div id="user-id" class="hidden"></div>
								<div id="user-info" class="hidden"></div>
								<div id="user-name"></div>
								<div id="company-name"></div>
								<div id="user-title"></div>
								<div>Verified Email Address:</div>
								<div>--------<span id="email-domain"></span></div>
								<div id="user-bio"></div>
							</div>
						</div><!-- profile description card -->

						<div class="mdl-card" style="top:25px">
							<div class="mdl-card__title">
								<h6 class="mdl-card__title-text">
									What is a Priority Pitch?
								</h6>
							</div>
							<ul class='mdl-card__supporting-text mdl-list'>
								<li class="substitute-variable mdl-list__item">Fill out the form to submit your meeting to {{user-first-name}}</li>
								<li class="mdl-list__item">$8 is charged to your card when you submit your bid</li>
								<li class="substitute-variable mdl-list__item">Pitch is shown to {{user-first-name}}</li>
							</ul>
						</div><!-- service description card -->

					</div><!-- left panel -->

					<div class="mdl-cell mdl-cell--9-col">
						<div id="bid-form-submit" class="hidden main-content mdl-card">
							<span id="bid-form-submit-pending">Pending...</span>
							<span id="bid-form-submit-success" class="hidden" >Success!</span>
							<span id="bid-form-submit-failure" class="hidden" >Failure :(</span>
						</div>
						<div id="bid-form-card" class="main-content mdl-card">
							<form id="bid-form" autocomplete="on">

								<div class="mdl-card__title">
									<h6 class="mdl-card__title-text">
										Your Pitch
									</h6>
								</div><!-- title -->

								<div class='mdl-card__supporting-text'>
									<div class="mdl-grid">
										<div class="mdl-cell mdl-cell--6-col">
											<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
												<input type="text" id="pitcher-first-name" class="mdl-textfield__input">
												<label for="user" class="mdl-textfield__label">First Name</label>
												<span class="mdl-textfield__error">First Name is required</span>
											</div>
										</div>
										<div class="mdl-cell mdl-cell--6-col">
											<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
												<input type="text" id="pitcher-last-name" class="mdl-textfield__input">
												<label for="user" class="mdl-textfield__label">Last Name</label>
												<span class="mdl-textfield__error">Last Name is required</span>
											</div>
										</div>

										<div class="mdl-cell mdl-cell--12-col">
											<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
												<input type="text" id="pitcher-email" class="mdl-textfield__input" pattern="[a-zA-Z0-9!#\$%&'\*\+-\/=\?\^_`\{\|\}~\.]+@[a-zA-Z0-9\-]+\.[a-zA-Z]+">
												<label for="user" class="mdl-textfield__label">Email Address</label>
												<span class="mdl-textfield__error">A valid email address is required</span>
											</div>
										</div>

										<div class="mdl-cell mdl-cell--12-col">
											<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
												<input type="text" id="pitcher-company-name" class="mdl-textfield__input">
												<label for="user" class="mdl-textfield__label">Company Name</label>
											</div>
										</div>

										<div class="mdl-cell mdl-cell--8-col">
											<label class="substitute-variable">Explain your product or service and why {{user-first-name}} might be interested</label>
										</div>
										<div class="mdl-layout-spacer"></div>
										<div class="mdl-cell mdl-cell--1-col" id="descriptionCharacterCountContainer" >
											(<span id="descriptionCharacterCount">0</span>/700)
										</div>
										<div class="mdl-cell mdl-cell--12-col mdl-textfield mdl-js-textfield">
											<textarea class="pitchArea mdl-textfield__input" rows="10" id="description" ></textarea>
											<span class="mdl-textfield__error">You must enter a pitch</span>
										</div>
										<div class="mdl-cell mdl-cell--12-col">
											<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
												<input type="number" step="0.01" min="0" id="bid-amount" class="mdl-textfield__input" pattern="-?[0-9]*(\.[0-9]+)?">
												<label for="user" class="mdl-textfield__label">Bid Amount</label>
												<span class="mdl-textfield__error">Bid must be a valid dollar amount</span>
											</div>
										</div>
									</div>
									<div class="mdl-grid">
										<div class="mdl-layout-spacer"></div>
										<div class="mdl-cell mdl-cell--2-col">
											<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
												<button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
													Submit Bid
												</button>
											</div>
										</div>
									</div>
								</div><!-- supporting-text -->

							</form>
						</div> <!-- pitch form card -->

					</div> <!-- 9-wide mdl cell -->
				</div> <!-- mdl grid -->
			</main> <!-- area under header -->
		</div> <!-- mdl main content wrapper -->
	</body>
</html>
